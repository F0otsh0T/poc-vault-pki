#









##
```

```






## HELM INSTALL VAULT
```
# kubectl create namespace demo

# helm install --name=vaultdemo \
--namespace="demo" \
--set='server.dev.enabled=true' \
--set Server.ingress.hosts[0].host={vaultdemo.10.10.10.179.xip.io} \
. -f values.yaml

NAME:   vaultdemo
LAST DEPLOYED: Mon Jun 22 20:33:44 2020
NAMESPACE: demo
STATUS: DEPLOYED

RESOURCES:
==> v1/ClusterRoleBinding
NAME                              AGE
vaultdemo-agent-injector-binding  0s

==> v1beta1/ClusterRoleBinding
vaultdemo-server-binding  0s

==> v1beta1/Ingress
NAME       HOSTS                             ADDRESS  PORTS  AGE
vaultdemo  vaultdemo.10.10.10.179.xip.io  80       0s

==> v1beta1/MutatingWebhookConfiguration
NAME                          AGE
vaultdemo-agent-injector-cfg  0s

==> v1/ServiceAccount
NAME                      SECRETS  AGE
vaultdemo-agent-injector  1        0s
vaultdemo                 1        0s

==> v1/ClusterRole
NAME                                  AGE
vaultdemo-agent-injector-clusterrole  0s

==> v1/Service
NAME                          TYPE       CLUSTER-IP      EXTERNAL-IP  PORT(S)                        AGE
vaultdemo-agent-injector-svc  ClusterIP  10.105.93.213   <none>       443/TCP                        0s
vaultdemo                     NodePort   10.100.119.172  <none>       8200:30014/TCP,8201:31645/TCP  0s
vaultdemo-ui                  NodePort   10.109.18.36    <none>       8200:30015/TCP                 0s

==> v1/Deployment
NAME                      DESIRED  CURRENT  UP-TO-DATE  AVAILABLE  AGE
vaultdemo-agent-injector  1        0        0           0          0s

==> v1/StatefulSet
NAME       DESIRED  CURRENT  AGE
vaultdemo  1        0        0s


NOTES:

Thank you for installing HashiCorp Vault!

Now that you have deployed Vault, you should look over the docs on using
Vault with Kubernetes available here:

https://www.vaultproject.io/docs/


Your release is named vaultdemo. To learn more about the release, try:

  $ helm status vaultdemo
  $ helm get vaultdemo

```

```
# helm install --name=vaultdemo \
--namespace="demo" \
--set Server.ingress.hosts[0].host={vaultdemo.10.10.10.179.xip.io} \
. -f values.yaml

NAME:   vaultdemo
LAST DEPLOYED: Mon Jun 22 20:52:22 2020
NAMESPACE: demo
STATUS: DEPLOYED

RESOURCES:
==> v1/ConfigMap
NAME              DATA  AGE
vaultdemo-config  1     0s

==> v1/ServiceAccount
NAME                      SECRETS  AGE
vaultdemo-agent-injector  1        0s
vaultdemo                 1        0s

==> v1/ClusterRole
NAME                                  AGE
vaultdemo-agent-injector-clusterrole  0s

==> v1/ClusterRoleBinding
NAME                              AGE
vaultdemo-agent-injector-binding  0s

==> v1/Service
NAME                          TYPE       CLUSTER-IP     EXTERNAL-IP  PORT(S)                        AGE
vaultdemo-agent-injector-svc  ClusterIP  10.96.97.72    <none>       443/TCP                        0s
vaultdemo                     NodePort   10.105.98.217  <none>       8200:30014/TCP,8201:31313/TCP  0s
vaultdemo-ui                  NodePort   10.104.71.44   <none>       8200:30015/TCP                 0s

==> v1/Deployment
NAME                      DESIRED  CURRENT  UP-TO-DATE  AVAILABLE  AGE
vaultdemo-agent-injector  1        0        0           0          0s

==> v1beta1/Ingress
NAME       HOSTS                             ADDRESS  PORTS  AGE
vaultdemo  vaultdemo.10.10.10.179.xip.io  80       0s

==> v1beta1/ClusterRoleBinding
NAME                      AGE
vaultdemo-server-binding  0s

==> v1/StatefulSet
NAME       DESIRED  CURRENT  AGE
vaultdemo  1        0        0s

==> v1beta1/MutatingWebhookConfiguration
NAME                          AGE
vaultdemo-agent-injector-cfg  0s


NOTES:

Thank you for installing HashiCorp Vault!

Now that you have deployed Vault, you should look over the docs on using
Vault with Kubernetes available here:

https://www.vaultproject.io/docs/


Your release is named vaultdemo. To learn more about the release, try:

  $ helm status vaultdemo
  $ helm get vaultdemo
```






## SET JWT & K8S CERT FOR VAULT AUTH KUBERNETES METHOD
```
# vault login <TOKEN>
Success! You are now authenticated. The token information displayed below
is already stored in the token helper. You do NOT need to run "vault login"
again. Future Vault requests will automatically use this token.

Key                  Value
---                  -----
token                <TOKEN>
token_accessor       <TOKEN_ACESSOR>>
token_duration       âˆž
token_renewable      false
token_policies       [""]
identity_policies    []
policies             [""]

# vault auth enable kubernetes
Success! Enabled kubernetes auth method at: kubernetes/

# vault write auth/kubernetes/config \
token_reviewer_jwt="$(cat /var/run/secrets/kubernetes.io/serviceaccount/token | tr '\r\n' ' ')" \
kubernetes_host=https://${KUBERNETES_PORT_443_TCP_ADDR}:443 \
kubernetes_ca_cert=@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt
Success! Data written to: auth/kubernetes/config





```






## WRITE VAULT AUTH KUBERNETES ROLE
```
# vault write auth/kubernetes/role/poc-04-01 \
bound_service_account_names=poc-04-01 \
bound_service_account_namespaces=demo \
policies=global.crudl \
ttl=1h
Success! Data written to: auth/kubernetes/role/poc-04-01

```



## PATCH / EDIT DEPLOYMENT
```
kubectl -n demo patch deployment poc-04-01 --patch "$(cat patch.yaml)"
deployment.extensions "poc-04-01" patched

```






#### SERVICE ACCOUNT / VAULT AUTH KUBERNETES ROLE
Remember, K8s Service Account must be associated in Vault Auth Kubernetes Role:
- VAULT AUTH KUBERNETES ROLE
    ```
    # vault read auth/kubernetes/role/vaultdemo
    Key                                 Value
    ---                                 -----
    bound_service_account_names         [vaultdemo]
    bound_service_account_namespaces    [demo]
    policies                            [global.crudl]
    token_bound_cidrs                   []
    token_explicit_max_ttl              0s
    token_max_ttl                       0s
    token_no_default_policy             false
    token_num_uses                      0
    token_period                        0s
    token_policies                      [global.crudl]
    token_ttl                           1h
    token_type                          default
    ttl                                 1h
    ```
- KUBERNETES SERVICEACCOUNT
    ```
    k -n demo get serviceaccount vaultdemo -o yaml                   
    apiVersion: v1
    kind: ServiceAccount
    metadata:
      annotations:
        meta.helm.sh/release-name: vaultdemo
        meta.helm.sh/release-namespace: demo
      creationTimestamp: "2020-07-09T19:20:36Z"
      labels:
        app.kubernetes.io/instance: vaultdemo
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/name: vault
        helm.sh/chart: vault-0.4.0
      managedFields:
      - apiVersion: v1
        fieldsType: FieldsV1
        fieldsV1:
          f:metadata:
            f:annotations:
              .: {}
              f:meta.helm.sh/release-name: {}
              f:meta.helm.sh/release-namespace: {}
            f:labels:
              .: {}
              f:app.kubernetes.io/instance: {}
              f:app.kubernetes.io/managed-by: {}
              f:app.kubernetes.io/name: {}
              f:helm.sh/chart: {}
        manager: Go-http-client
        operation: Update
        time: "2020-07-09T19:20:36Z"
      - apiVersion: v1
        fieldsType: FieldsV1
        fieldsV1:
          f:secrets:
            .: {}
            k:{"name":"vaultdemo-token-kvtrf"}:
              .: {}
              f:name: {}
        manager: kube-controller-manager
        operation: Update
        time: "2020-07-09T19:20:36Z"
      name: vaultdemo
      namespace: demo
      resourceVersion: "4434360"
      selfLink: /api/v1/namespaces/demo/serviceaccounts/vaultdemo
      uid: dfcf06c1-eed5-4d0a-8368-cbda7d182f20
    secrets:
    - name: vaultdemo-token-kvtrf
    ```